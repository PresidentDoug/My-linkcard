<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LinkCard | Digital Business Card</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css" rel="stylesheet">
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const MY_FIREBASE_CONFIG = {
            apiKey: "AIzaSyCHGHpLgbDv1gfUyhSQkaR0SxBpx5S6rZI",
            authDomain: "linkcard-9bb87.firebaseapp.com",
            projectId: "linkcard-9bb87",
            storageBucket: "linkcard-9bb87.firebasestorage.app",
            messagingSenderId: "859925443097",
            appId: "1:859925443097:web:f5755ba414a058cfeb3088",
            measurementId: "G-LS7RVNP2YN"
        };

        const app = initializeApp(MY_FIREBASE_CONFIG);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'link-card-live'; 

        window.fb = { auth, db, appId, user: null };

        window.initFirebase = async () => {
            try {
                const cred = await signInAnonymously(auth);
                window.fb.user = cred.user;
                return cred.user;
            } catch(e) { 
                console.error("Auth failed:", e);
                window.showToast("Auth Error: " + e.message);
                return null;
            }
        };

        onAuthStateChanged(auth, (user) => {
            window.fb.user = user;
            if (user) window.dispatchEvent(new CustomEvent('authReady', { detail: user }));
        });
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .glass-card { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.2); box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07); }
        .gradient-bg { background: linear-gradient(135deg, #6366f1 0%, #a855f7 100%); transition: background 0.5s ease; }
        #qrcode canvas, #qrcode img { margin: 0 auto; border-radius: 12px; }
        .viewer-mode #editor-panel { display: none; }
        .viewer-mode #main-container { grid-template-columns: 1fr; display: flex; justify-content: center; }
        .viewer-mode .sticky { position: relative; top: 0; }
        @keyframes scan { 0% { top: 0; } 50% { top: 100%; } 100% { top: 0; } }
        .scan-line { height: 2px; background: rgba(99, 102, 241, 0.5); width: 100%; position: absolute; animation: scan 2s infinite linear; box-shadow: 0 0 8px rgba(99, 102, 241, 0.8); }
        .loading-spinner { border: 3px solid rgba(255,255,255,0.3); border-radius: 50%; border-top: 3px solid #fff; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="min-h-screen text-slate-800">

    <div class="max-w-6xl mx-auto px-4 py-8 md:py-12">
        <header id="app-header" class="text-center mb-12">
            <h1 class="text-4xl font-extrabold tracking-tight text-slate-900 sm:text-5xl">
                Link<span class="text-indigo-600">Card</span>
            </h1>
            <p id="app-subtitle" class="mt-4 text-lg text-slate-600">Your digital identity, live and global.</p>
            <div id="viewer-controls" class="hidden mt-6 flex justify-center gap-4">
                <button onclick="exitViewer()" class="px-6 py-2 bg-white border border-slate-200 rounded-full text-sm font-semibold text-slate-600 hover:bg-slate-50 shadow-sm transition-all">
                    <i class="fas fa-plus mr-2"></i> Create Your Own Card
                </button>
            </div>
        </header>

        <div id="main-container" class="grid grid-cols-1 lg:grid-cols-2 gap-12 items-start">
            <div id="editor-panel" class="space-y-8">
                <section class="glass-card p-6 rounded-3xl">
                    <h2 class="text-xl font-bold mb-6 flex items-center">
                        <span class="w-8 h-8 gradient-bg text-white rounded-full flex items-center justify-center mr-3 text-sm">1</span>
                        Basic Information
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Full Name</label>
                            <input type="text" id="input-name" placeholder="Alex Rivera" class="w-full px-4 py-2 rounded-xl border border-slate-200 focus:ring-2 focus:ring-indigo-500 outline-none transition-all">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">Profession</label>
                            <input type="text" id="input-job" placeholder="Software Engineer" class="w-full px-4 py-2 rounded-xl border border-slate-200 focus:ring-2 focus:ring-indigo-500 outline-none transition-all">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-slate-700 mb-1">Short Bio</label>
                            <textarea id="input-bio" placeholder="Building the future of the web..." rows="2" class="w-full px-4 py-2 rounded-xl border border-slate-200 focus:ring-2 focus:ring-indigo-500 outline-none transition-all"></textarea>
                        </div>
                    </div>
                </section>

                <section class="glass-card p-6 rounded-3xl">
                    <h2 class="text-xl font-bold mb-6 flex items-center">
                        <span class="w-8 h-8 gradient-bg text-white rounded-full flex items-center justify-center mr-3 text-sm">2</span>
                        Social Links
                    </h2>
                    <div id="links-container" class="space-y-4"></div>
                    <button id="add-link-btn" class="mt-6 w-full py-3 rounded-xl border-2 border-dashed border-slate-300 text-slate-500 font-medium hover:border-indigo-500 hover:text-indigo-500 transition-all flex items-center justify-center">
                        <i class="fas fa-plus mr-2"></i> Add Another Link
                    </button>
                </section>

                <section class="glass-card p-6 rounded-3xl">
                    <h2 class="text-xl font-bold mb-6 flex items-center">
                        <span class="w-8 h-8 gradient-bg text-white rounded-full flex items-center justify-center mr-3 text-sm">3</span>
                        Appearance
                    </h2>
                    <div class="flex items-center gap-4">
                        <label class="block text-sm font-medium text-slate-700">Theme Color</label>
                        <input type="color" id="input-color" value="#6366f1" class="h-10 w-20 rounded cursor-pointer">
                    </div>
                </section>
            </div>

            <div class="sticky top-8 w-full flex justify-center">
                <div class="flex flex-col items-center w-full max-w-sm">
                    <div id="digital-card" class="bg-white rounded-[2.5rem] shadow-2xl overflow-hidden relative border border-slate-100 min-h-[550px] flex flex-col w-full">
                        <div id="card-header" class="h-32 gradient-bg relative">
                            <div class="absolute -bottom-12 left-1/2 -translate-x-1/2">
                                <div class="w-24 h-24 rounded-full border-4 border-white bg-slate-200 overflow-hidden shadow-lg flex items-center justify-center">
                                    <i class="fas fa-user text-3xl text-slate-400"></i>
                                </div>
                            </div>
                        </div>
                        <div class="mt-16 px-8 text-center flex-grow">
                            <h3 id="preview-name" class="text-2xl font-bold text-slate-900">Your Name</h3>
                            <p id="preview-job" class="text-slate-500 font-medium">Your Profession</p>
                            <p id="preview-bio" class="text-slate-600 mt-3 text-sm italic">Tell the world about yourself...</p>
                            <div id="preview-links" class="mt-8 space-y-3 pb-8"></div>
                        </div>
                        <div class="p-6 bg-slate-50 border-t border-slate-100 flex justify-between items-center">
                            <button onclick="downloadVCF()" class="text-xs font-bold uppercase tracking-wider text-slate-400 hover:text-indigo-600 transition-colors">
                                <i class="fas fa-id-card mr-1"></i> Add to Contacts
                            </button>
                            <button onclick="toggleQR()" class="w-10 h-10 rounded-full bg-white border border-slate-200 flex items-center justify-center text-slate-600 hover:bg-slate-100 transition-all">
                                <i class="fas fa-qrcode"></i>
                            </button>
                        </div>

                        <div id="qr-overlay" class="absolute inset-0 bg-white/95 hidden flex-col items-center justify-center p-8 text-center transition-all z-20">
                            <h4 class="font-bold text-lg mb-2 text-slate-800">Your Personal QR</h4>
                            <p id="qr-status" class="text-xs text-slate-500 mb-6 px-4">Publish your card to generate a clean QR code.</p>
                            <div id="qr-container" class="relative hidden">
                                <div id="qrcode" class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 overflow-hidden"></div>
                                <div class="scan-line"></div>
                            </div>
                            <div id="qr-placeholder" class="w-40 h-40 bg-slate-100 rounded-2xl flex items-center justify-center border-2 border-dashed border-slate-200">
                                <i class="fas fa-cloud-upload-alt text-slate-300 text-3xl"></i>
                            </div>
                            <div class="flex gap-3 mt-8">
                                <button id="publish-btn-qr" onclick="publishCard()" class="px-4 py-2 bg-indigo-600 text-white rounded-xl text-sm font-bold hover:bg-indigo-700 transition-all flex items-center">
                                    <span>Publish Now</span>
                                </button>
                                <button onclick="toggleQR()" class="px-4 py-2 bg-slate-100 text-slate-600 rounded-xl text-sm font-bold hover:bg-slate-200 transition-all">Close</button>
                            </div>
                        </div>
                    </div>

                    <div id="editor-actions" class="mt-8 flex flex-col gap-4 w-full">
                        <button id="publish-btn" onclick="publishCard()" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold hover:bg-indigo-700 transition-all shadow-lg flex items-center justify-center gap-3">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <span id="publish-text">Publish Card to Cloud</span>
                            <div id="publish-spinner" class="loading-spinner hidden"></div>
                        </button>
                        <p class="text-center text-xs text-slate-400">Publishing creates a permanent link for your QR code.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="toast" class="fixed bottom-8 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-6 py-3 rounded-full shadow-2xl transition-all opacity-0 translate-y-10 pointer-events-none z-50 text-center min-w-[300px]"></div>

    <script type="module">
        import { doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const PLATFORMS = {
            linkedin: { name: 'LinkedIn', icon: 'fab fa-linkedin', color: '#0077b5', placeholder: 'linkedin.com/in/username' },
            twitter: { name: 'X / Twitter', icon: 'fab fa-x-twitter', color: '#000000', placeholder: 'twitter.com/username' },
            bluesky: { name: 'Bluesky', icon: 'fab fa-bluesky', color: '#0560ff', placeholder: 'bsky.app/profile/name.bsky.social' },
            github: { name: 'GitHub', icon: 'fab fa-github', color: '#333', placeholder: 'github.com/username' },
            instagram: { name: 'Instagram', icon: 'fab fa-instagram', color: '#e4405f', placeholder: 'instagram.com/username' },
            snapchat: { name: 'Snapchat', icon: 'fab fa-snapchat', color: '#FFFC00', darkText: true, placeholder: 'snapchat.com/add/username' },
            steam: { name: 'Steam', icon: 'fab fa-steam', color: '#171a21', placeholder: 'steamcommunity.com/id/name' },
            website: { name: 'Website', icon: 'fas fa-globe', color: '#6366f1', placeholder: 'yourwebsite.com' },
            email: { name: 'Email', icon: 'fas fa-envelope', color: '#ea4335', placeholder: 'hello@example.com' },
            phone: { name: 'Phone', icon: 'fas fa-phone', color: '#34a853', placeholder: '+1 234 567 890' }
        };

        let userLinks = [{ id: Date.now(), platform: 'linkedin', url: '' }];
        let isViewerMode = false;
        let currentDocId = null;

        const linksContainer = document.getElementById('links-container');
        const inputName = document.getElementById('input-name');
        const inputJob = document.getElementById('input-job');
        const inputBio = document.getElementById('input-bio');
        const inputColor = document.getElementById('input-color');
        const previewLinks = document.getElementById('preview-links');
        const cardHeader = document.getElementById('card-header');

        window.addEventListener('authReady', async () => {
            const params = new URLSearchParams(window.location.search);
            const cloudId = params.get('id');
            if (cloudId) { await loadCardFromCloud(cloudId); } 
            else { loadFromStorage(); renderInputs(); updatePreview(); }
        });

        async function loadCardFromCloud(id) {
            if (!window.fb) return;
            try {
                const { db, appId } = window.fb;
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', id);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    inputName.value = data.name || '';
                    inputJob.value = data.job || '';
                    inputBio.value = data.bio || '';
                    inputColor.value = data.color || '#6366f1';
                    userLinks = data.links || [];
                    currentDocId = id;
                    enterViewerMode();
                    updatePreview();
                }
            } catch (e) { 
                console.error("Cloud load error:", e);
                window.showToast("Load Error: " + e.message);
            }
        }

        window.publishCard = async () => {
            if (!window.fb) {
                window.showToast("App initialization failed. Please refresh.");
                return;
            }
            const { db, appId } = window.fb;
            let user = window.fb.user;

            if (!user) {
                window.showToast("Authenticating...");
                user = await window.initFirebase();
            }

            if (!user) {
                window.showToast("Authentication failed. Ensure 'Anonymous' is enabled in Firebase Console.");
                return;
            }

            const btn = document.getElementById('publish-btn');
            btn.disabled = true;
            document.getElementById('publish-spinner').classList.remove('hidden');

            try {
                const cardId = currentDocId || (Date.now().toString(36) + Math.random().toString(36).substr(2, 5));
                const docRef = doc(db, 'artifacts', appId, 'public', 'data', cardId);
                
                await setDoc(docRef, {
                    name: inputName.value, job: inputJob.value, bio: inputBio.value,
                    color: inputColor.value, links: userLinks.filter(l => l.url),
                    owner: user.uid, updatedAt: Date.now()
                });

                currentDocId = cardId;
                generateQRCode(cardId);
                window.showToast("Card published live!");
                
                const url = new URL(window.location);
                url.searchParams.set('id', cardId);
                window.history.pushState({}, '', url);
                
                document.getElementById('qr-container').classList.remove('hidden');
                document.getElementById('qr-placeholder').classList.add('hidden');
                document.getElementById('qr-status').innerText = "Scannable link is live!";
            } catch (e) { 
                window.showToast("Publish Error: " + e.message);
                console.error(e); 
            } 
            finally { 
                btn.disabled = false; 
                document.getElementById('publish-spinner').classList.add('hidden'); 
            }
        };

        function enterViewerMode() {
            isViewerMode = true;
            document.body.classList.add('viewer-mode');
            document.getElementById('viewer-controls').classList.remove('hidden');
            document.getElementById('app-subtitle').innerText = "Verified LinkCard Profile";
        }

        window.exitViewer = () => { window.location.href = window.location.pathname; };

        function renderInputs() {
            if (isViewerMode) return;
            linksContainer.innerHTML = '';
            userLinks.forEach((link, index) => {
                const div = document.createElement('div');
                div.className = 'flex flex-col md:flex-row gap-3 p-4 bg-slate-50 rounded-2xl border border-slate-100';
                div.innerHTML = `
                    <select onchange="updateLink(${index}, 'platform', this.value)" class="px-3 py-2 rounded-lg border border-slate-200 text-sm">
                        ${Object.entries(PLATFORMS).map(([k, v]) => `<option value="${k}" ${link.platform === k ? 'selected' : ''}>${v.name}</option>`).join('')}
                    </select>
                    <input type="text" value="${link.url}" oninput="updateLink(${index}, 'url', this.value)" placeholder="${PLATFORMS[link.platform].placeholder}" class="flex-grow px-3 py-2 rounded-lg border border-slate-200 text-sm">
                    <button onclick="removeLink(${index})" class="text-slate-400 hover:text-red-500 p-2"><i class="fas fa-trash-alt"></i></button>
                `;
                linksContainer.appendChild(div);
            });
        }

        window.updateLink = (i, f, v) => { userLinks[i][f] = v; if (f === 'platform') renderInputs(); updatePreview(); };
        window.removeLink = (i) => { userLinks.splice(i, 1); renderInputs(); updatePreview(); };

        function updatePreview() {
            document.getElementById('preview-name').innerText = inputName.value || 'Your Name';
            document.getElementById('preview-job').innerText = inputJob.value || 'Your Profession';
            document.getElementById('preview-bio').innerText = inputBio.value || 'Tell the world about yourself...';
            cardHeader.style.background = `linear-gradient(135deg, ${inputColor.value} 0%, ${adjustColor(inputColor.value, -40)} 100%)`;
            previewLinks.innerHTML = '';
            userLinks.forEach(link => {
                if (!link.url) return;
                const platform = PLATFORMS[link.platform];
                const linkEl = document.createElement('a');
                linkEl.href = link.url.startsWith('http') ? link.url : 'https://' + link.url;
                linkEl.target = "_blank";
                linkEl.className = "flex items-center p-3 rounded-2xl bg-white border border-slate-100 shadow-sm hover:shadow-md transition-all group";
                linkEl.innerHTML = `
                    <div class="w-10 h-10 rounded-xl flex items-center justify-center ${platform.darkText ? 'text-slate-900' : 'text-white'}" style="background-color: ${platform.color}">
                        <i class="${platform.icon}"></i>
                    </div>
                    <span class="ml-4 font-semibold text-slate-700">${platform.name}</span>
                `;
                previewLinks.appendChild(linkEl);
            });
            if (currentDocId) generateQRCode(currentDocId);
        }

        function generateQRCode(id) {
            const qrDiv = document.getElementById('qrcode');
            qrDiv.innerHTML = '';
            const url = new URL(window.location.href);
            url.search = `?id=${id}`;
            new QRCode(qrDiv, { text: url.toString(), width: 180, height: 180, colorDark: "#1e293b", colorLight: "#ffffff", correctLevel: QRCode.CorrectLevel.H });
        }

        window.toggleQR = () => { document.getElementById('qr-overlay').classList.toggle('hidden'); document.getElementById('qr-overlay').classList.toggle('flex'); };
        
        window.downloadVCF = () => {
            const name = inputName.value || 'Contact';
            const vcf = `BEGIN:VCARD\nVERSION:3.0\nFN:${name}\nTITLE:${inputJob.value}\nEND:VCARD`;
            const blob = new Blob([vcf], { type: 'text/vcard' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `${name}.vcf`; a.click();
        };

        function saveToStorage() { localStorage.setItem('linkcard_data', JSON.stringify({ name: inputName.value, job: inputJob.value, bio: inputBio.value, color: inputColor.value, links: userLinks })); }
        function loadFromStorage() {
            const saved = localStorage.getItem('linkcard_data');
            if (saved) {
                const data = JSON.parse(saved);
                inputName.value = data.name || ''; inputJob.value = data.job || ''; inputBio.value = data.bio || ''; inputColor.value = data.color || '#6366f1'; userLinks = data.links || [];
            }
        }

        window.showToast = (msg) => {
            const t = document.getElementById('toast'); t.innerText = msg; t.classList.remove('opacity-0', 'translate-y-10');
            setTimeout(() => t.classList.add('opacity-0', 'translate-y-10'), 5000);
        }

        function adjustColor(hex, amt) {
            var num = parseInt(hex.slice(1), 16), r = (num >> 16) + amt, b = ((num >> 8) & 0x00FF) + amt, g = (num & 0x0000FF) + amt;
            const norm = (v) => Math.min(255, Math.max(0, v));
            return "#" + (norm(g) | (norm(b) << 8) | (norm(r) << 16)).toString(16).padStart(6, '0');
        }

        inputName.addEventListener('input', () => { updatePreview(); saveToStorage(); });
        inputJob.addEventListener('input', () => { updatePreview(); saveToStorage(); });
        inputBio.addEventListener('input', () => { updatePreview(); saveToStorage(); });
        inputColor.addEventListener('input', () => { updatePreview(); saveToStorage(); });
        document.getElementById('add-link-btn').addEventListener('click', () => { userLinks.push({ id: Date.now(), platform: 'website', url: '' }); renderInputs(); updatePreview(); });

        window.initFirebase();
    </script>
</body>
</html>
